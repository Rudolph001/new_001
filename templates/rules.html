{% extends "base.html" %}

{% block title %}Rules Management - Email Guardian{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
        <li class="breadcrumb-item active">Rules Management</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="fas fa-gavel text-primary me-2"></i>
                Security Rules Management
            </h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newRuleModal">
                <i class="fas fa-plus me-2"></i>
                Add New Rule
            </button>
        </div>
    </div>
</div>

<!-- Rule Categories -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card bg-light">
            <div class="card-body text-center">
                <i class="fas fa-shield-alt fa-2x text-primary mb-2"></i>
                <h5>Security Rules</h5>
                <span class="badge bg-primary">{{ rule_counts.security_active if rule_counts else 0 }} Active</span>
                <small class="d-block text-muted">{{ rule_counts.security_total if rule_counts else 0 }} Total</small>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card bg-light">
            <div class="card-body text-center">
                <i class="fas fa-filter fa-2x text-warning mb-2"></i>
                <h5>Exclusion Rules</h5>
                <span class="badge bg-warning">{{ rule_counts.exclusion_active if rule_counts else 0 }} Active</span>
                <small class="d-block text-muted">{{ rule_counts.exclusion_total if rule_counts else 0 }} Total</small>
            </div>
        </div>
    </div>
</div>

<!-- Rules Tabs -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <ul class="nav nav-tabs card-header-tabs" id="rulesTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab">
                        <i class="fas fa-shield-alt me-2"></i>Security Rules
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="exclusion-tab" data-bs-toggle="tab" data-bs-target="#exclusion" type="button" role="tab">
                        <i class="fas fa-filter me-2"></i>Exclusion Rules
                    </button>
                </li>
            </ul>
            <div>
                <button class="btn btn-sm btn-outline-primary" onclick="importRules()">
                    <i class="fas fa-upload me-1"></i>
                    Import
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="exportRules()">
                    <i class="fas fa-download me-1"></i>
                    Export
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="tab-content" id="rulesTabContent">
            <!-- Security Rules Tab -->
            <div class="tab-pane fade show active" id="security" role="tabpanel">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Rule Name</th>
                                <th>Description</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if security_rules %}
                                {% for rule in security_rules %}
                                <tr>
                                    <td>
                                        <strong>{{ rule.name }}</strong>
                                    </td>
                                    <td>{{ rule.description or 'No description' }}</td>
                                    <td>
                                        <span class="badge bg-info">{{ rule.priority }}</span>
                                    </td>
                                    <td>
                                        {% if rule.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="editRule({{ rule.id }})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="toggleRule({{ rule.id }})">
                                                <i class="fas fa-{% if rule.is_active %}pause{% else %}play{% endif %}"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="deleteRule({{ rule.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <i class="fas fa-info-circle text-muted me-2"></i>
                                        No security rules found. <a href="#" onclick="$('#newRuleModal').modal('show')">Create your first rule</a>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Exclusion Rules Tab -->
            <div class="tab-pane fade" id="exclusion" role="tabpanel">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Rule Name</th>
                                <th>Description</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if exclusion_rules %}
                                {% for rule in exclusion_rules %}
                                <tr>
                                    <td>
                                        <strong>{{ rule.name }}</strong>
                                    </td>
                                    <td>{{ rule.description or 'No description' }}</td>
                                    <td>
                                        <span class="badge bg-info">{{ rule.priority }}</span>
                                    </td>
                                    <td>
                                        {% if rule.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="editRule({{ rule.id }})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="toggleRule({{ rule.id }})">
                                                <i class="fas fa-{% if rule.is_active %}pause{% else %}play{% endif %}"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="deleteRule({{ rule.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <i class="fas fa-info-circle text-muted me-2"></i>
                                        No exclusion rules found. <a href="#" onclick="$('#newRuleModal').modal('show')">Create your first rule</a>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Rule Modal -->
<div class="modal fade" id="newRuleModal" tabindex="-1" aria-labelledby="newRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newRuleModalLabel">Create New Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="ruleForm">
                    <div class="mb-3">
                        <label for="ruleName" class="form-label">Rule Name</label>
                        <input type="text" class="form-control" id="ruleName" required>
                    </div>
                    <div class="mb-3">
                        <label for="ruleDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="ruleDescription" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="ruleType" class="form-label">Rule Type</label>
                            <select class="form-select" id="ruleType" required>
                                <option value="security">Security Rule</option>
                                <option value="exclusion">Exclusion Rule</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="rulePriority" class="form-label">Priority</label>
                            <input type="number" class="form-control" id="rulePriority" value="1" min="1" max="100">
                        </div>
                    </div>
                    <div class="mb-3 mt-3">
                        <label class="form-label">Conditions</label>
                        <div id="conditionsContainer">
                            <div class="condition-group border p-3 mb-2">
                                <div class="row">
                                    <div class="col-md-4">
                                        <select class="form-select condition-field">
                                            <option value="sender">Sender</option>
                                            <option value="subject">Subject</option>
                                            <option value="attachments">Attachments</option>
                                            <option value="recipients_email_domain">Recipient Domain</option>
                                            <option value="leaver">Leaver Status</option>
                                            <option value="justification">Justification</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select condition-operator">
                                            <option value="equals">Equals</option>
                                            <option value="contains">Contains</option>
                                            <option value="not_equals">Not Equals</option>
                                            <option value="not_contains">Not Contains</option>
                                            <option value="starts_with">Starts With</option>
                                            <option value="ends_with">Ends With</option>
                                            <option value="regex">Regex Pattern</option>
                                            <option value="is_empty">Is Empty</option>
                                            <option value="is_not_empty">Is Not Empty</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" class="form-control condition-value" placeholder="Value">
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeCondition(this)">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addCondition()">
                            <i class="fas fa-plus me-1"></i>Add Condition
                        </button>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Actions</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="actionFlag">
                            <label class="form-check-label" for="actionFlag">Flag for Review</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="actionEscalate">
                            <label class="form-check-label" for="actionEscalate">Auto-Escalate</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveRule()">Save Rule</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Rule Modal -->
<div class="modal fade" id="editRuleModal" tabindex="-1" aria-labelledby="editRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRuleModalLabel">Edit Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editRuleForm">
                    <input type="hidden" id="editRuleId">
                    <div class="mb-3">
                        <label for="editRuleName" class="form-label">Rule Name</label>
                        <input type="text" class="form-control" id="editRuleName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editRuleDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editRuleDescription" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="editRuleType" class="form-label">Rule Type</label>
                            <select class="form-select" id="editRuleType" required>
                                <option value="security">Security Rule</option>
                                <option value="exclusion">Exclusion Rule</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editRulePriority" class="form-label">Priority</label>
                            <input type="number" class="form-control" id="editRulePriority" min="1" max="100">
                        </div>
                    </div>
                    <div class="mb-3 mt-3">
                        <label class="form-label">Conditions</label>
                        <div id="editConditionsContainer">
                            <!-- Conditions will be populated dynamically -->
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addEditCondition()">
                            <i class="fas fa-plus me-1"></i>Add Condition
                        </button>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Actions</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editActionFlag">
                            <label class="form-check-label" for="editActionFlag">Flag for Review</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editActionEscalate">
                            <label class="form-check-label" for="editActionEscalate">Auto-Escalate</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateRule()">Update Rule</button>
            </div>
        </div>
    </div>
</div>

<script>
let editingRuleId = null;

function addCondition() {
    const container = document.getElementById('conditionsContainer');
    const conditionHtml = `
        <div class="condition-group border p-3 mb-2">
            <div class="row">
                <div class="col-md-4">
                    <select class="form-select condition-field">
                        <option value="sender">Sender</option>
                        <option value="subject">Subject</option>
                        <option value="attachments">Attachments</option>
                        <option value="recipients_email_domain">Recipient Domain</option>
                        <option value="leaver">Leaver Status</option>
                        <option value="justification">Justification</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select condition-operator">
                        <option value="equals">Equals</option>
                        <option value="contains">Contains</option>
                        <option value="not_equals">Not Equals</option>
                        <option value="not_contains">Not Contains</option>
                        <option value="starts_with">Starts With</option>
                        <option value="ends_with">Ends With</option>
                        <option value="regex">Regex Pattern</option>
                        <option value="is_empty">Is Empty</option>
                        <option value="is_not_empty">Is Not Empty</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control condition-value" placeholder="Value">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeCondition(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', conditionHtml);
}

function removeCondition(button) {
    const container = document.getElementById('conditionsContainer');
    if (container.children.length > 1) {
        button.closest('.condition-group').remove();
    }
}

function addEditCondition() {
    const container = document.getElementById('editConditionsContainer');
    const conditionHtml = `
        <div class="condition-group border p-3 mb-2">
            <div class="row">
                <div class="col-md-4">
                    <select class="form-select condition-field">
                        <option value="sender">Sender</option>
                        <option value="subject">Subject</option>
                        <option value="attachments">Attachments</option>
                        <option value="recipients_email_domain">Recipient Domain</option>
                        <option value="leaver">Leaver Status</option>
                        <option value="justification">Justification</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select condition-operator">
                        <option value="equals">Equals</option>
                        <option value="contains">Contains</option>
                        <option value="not_equals">Not Equals</option>
                        <option value="not_contains">Not Contains</option>
                        <option value="starts_with">Starts With</option>
                        <option value="ends_with">Ends With</option>
                        <option value="regex">Regex Pattern</option>
                        <option value="is_empty">Is Empty</option>
                        <option value="is_not_empty">Is Not Empty</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control condition-value" placeholder="Value">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeEditCondition(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', conditionHtml);
}

function removeEditCondition(button) {
    const container = document.getElementById('editConditionsContainer');
    if (container.children.length > 1) {
        button.closest('.condition-group').remove();
    }
}

function saveRule() {
    const name = document.getElementById('ruleName').value;
    const description = document.getElementById('ruleDescription').value;
    const ruleType = document.getElementById('ruleType').value;
    const priority = document.getElementById('rulePriority').value;

    if (!name.trim()) {
        alert('Please enter a rule name');
        return;
    }

    // Collect conditions
    const conditions = [];
    const conditionGroups = document.querySelectorAll('#conditionsContainer .condition-group');

    conditionGroups.forEach(group => {
        const field = group.querySelector('.condition-field').value;
        const operator = group.querySelector('.condition-operator').value;
        const value = group.querySelector('.condition-value').value;

        if (field && operator && (value || ['is_empty', 'is_not_empty'].includes(operator))) {
            conditions.push({
                field: field,
                operator: operator,
                value: value
            });
        }
    });

    if (conditions.length === 0) {
        alert('Please add at least one condition');
        return;
    }

    // Collect actions
    const actions = {};
    if (document.getElementById('actionFlag').checked) {
        actions.flag = true;
    }
    if (document.getElementById('actionEscalate').checked) {
        actions.escalate = true;
    }

    const ruleData = {
        name: name,
        description: description,
        rule_type: ruleType,
        priority: parseInt(priority),
        conditions: conditions,
        actions: actions
    };

    fetch('/api/rules', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(ruleData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Rule created successfully!');
            location.reload();
        } else {
            alert('Error creating rule: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating rule');
    });
}

function editRule(ruleId) {
    editingRuleId = ruleId;

    // Fetch rule details
    fetch(`/api/rules/${ruleId}`)
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (!data.success) {
            throw new Error(data.message || 'Failed to fetch rule details');
        }
        
        const rule = data;
        document.getElementById('editRuleId').value = rule.id;
        document.getElementById('editRuleName').value = rule.name || '';
        document.getElementById('editRuleDescription').value = rule.description || '';
        document.getElementById('editRuleType').value = rule.rule_type || 'security';
        document.getElementById('editRulePriority').value = rule.priority || 1;

        // Populate conditions
        const container = document.getElementById('editConditionsContainer');
        container.innerHTML = '';

        if (rule.conditions && Array.isArray(rule.conditions) && rule.conditions.length > 0) {
            rule.conditions.forEach(condition => {
                if (condition && typeof condition === 'object') {
                    addEditCondition();
                    const lastGroup = container.lastElementChild;
                    if (lastGroup) {
                        const fieldSelect = lastGroup.querySelector('.condition-field');
                        const operatorSelect = lastGroup.querySelector('.condition-operator');
                        const valueInput = lastGroup.querySelector('.condition-value');
                        
                        if (fieldSelect) fieldSelect.value = condition.field || 'sender';
                        if (operatorSelect) operatorSelect.value = condition.operator || 'equals';
                        if (valueInput) valueInput.value = condition.value || '';
                    }
                }
            });
        } else {
            addEditCondition();
        }

        // Populate actions
        const actions = rule.actions || {};
        document.getElementById('editActionFlag').checked = !!actions.flag;
        document.getElementById('editActionEscalate').checked = !!actions.escalate;

        // Show modal
        new bootstrap.Modal(document.getElementById('editRuleModal')).show();
    })
    .catch(error => {
        console.error('Error fetching rule:', error);
        alert(`Error fetching rule details: ${error.message}`);
    });
}

function updateRule() {
    const ruleId = document.getElementById('editRuleId').value;
    const name = document.getElementById('editRuleName').value;
    const description = document.getElementById('editRuleDescription').value;
    const ruleType = document.getElementById('editRuleType').value;
    const priority = document.getElementById('editRulePriority').value;

    if (!name.trim()) {
        alert('Please enter a rule name');
        return;
    }

    // Collect conditions
    const conditions = [];
    const conditionGroups = document.querySelectorAll('#editConditionsContainer .condition-group');

    conditionGroups.forEach(group => {
        const field = group.querySelector('.condition-field').value;
        const operator = group.querySelector('.condition-operator').value;
        const value = group.querySelector('.condition-value').value;

        if (field && operator && (value || ['is_empty', 'is_not_empty'].includes(operator))) {
            conditions.push({
                field: field,
                operator: operator,
                value: value
            });
        }
    });

    if (conditions.length === 0) {
        alert('Please add at least one condition');
        return;
    }

    // Collect actions
    const actions = {};
    if (document.getElementById('editActionFlag').checked) {
        actions.flag = true;
    }
    if (document.getElementById('editActionEscalate').checked) {
        actions.escalate = true;
    }

    const ruleData = {
        name: name,
        description: description,
        rule_type: ruleType,
        priority: parseInt(priority),
        conditions: conditions,
        actions: actions
    };

    fetch(`/api/rules/${ruleId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(ruleData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Rule updated successfully!');
            location.reload();
        } else {
            alert('Error updating rule: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating rule');
    });
}

function toggleRule(ruleId) {
    fetch(`/api/rules/${ruleId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            is_active: null // This will toggle the status
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error toggling rule: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error toggling rule');
    });
}

function deleteRule(ruleId) {
    if (confirm('Are you sure you want to delete this rule?')) {
        fetch(`/api/rules/${ruleId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting rule: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting rule');
        });
    }
}

function importRules() {
    alert('Import functionality coming soon!');
}

function exportRules() {
    alert('Export functionality coming soon!');
}
</script>

{% endblock %}