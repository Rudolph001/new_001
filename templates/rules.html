{% extends "base.html" %}

{% block title %}Rules Management - Email Guardian{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
        <li class="breadcrumb-item active">Rules Management</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="fas fa-gavel text-primary me-2"></i>
                Security Rules Management
            </h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newRuleModal">
                <i class="fas fa-plus me-2"></i>
                Add New Rule
            </button>
        </div>
    </div>
</div>

<!-- Rule Categories -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card bg-light">
            <div class="card-body text-center">
                <i class="fas fa-shield-alt fa-2x text-primary mb-2"></i>
                <h5>Security Rules</h5>
                <span class="badge bg-primary">{{ rule_counts.security_active if rule_counts else 0 }} Active</span>
                <small class="d-block text-muted">{{ rule_counts.security_total if rule_counts else 0 }} Total</small>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card bg-light">
            <div class="card-body text-center">
                <i class="fas fa-filter fa-2x text-info mb-2"></i>
                <h5>Exclusion Rules</h5>
                <span class="badge bg-info">{{ rule_counts.exclusion_active if rule_counts else 0 }} Active</span>
                <small class="d-block text-muted">{{ rule_counts.exclusion_total if rule_counts else 0 }} Total</small>
            </div>
        </div>
    </div>
</div>

<!-- Active Rules Tabs -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <ul class="nav nav-tabs card-header-tabs" id="rulesTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab">
                                <i class="fas fa-shield-alt me-2"></i>Security Rules
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="exclusion-tab" data-bs-toggle="tab" data-bs-target="#exclusion" type="button" role="tab">
                                <i class="fas fa-filter me-2"></i>Exclusion Rules
                            </button>
                        </li>
                    </ul>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="importRules()">
                            <i class="fas fa-upload me-1"></i>
                            Import
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportRules()">
                            <i class="fas fa-download me-1"></i>
                            Export
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="tab-content" id="rulesTabContent">
                    <!-- Security Rules Tab -->
                    <div class="tab-pane fade show active" id="security" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Rule Name</th>
                                        <th>Description</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if security_rules %}
                                        {% for rule in security_rules %}
                                        <tr>
                                            <td>
                                                <strong>{{ rule.name }}</strong>
                                                <br><small class="text-muted">{{ rule.description or 'No description' }}</small>
                                            </td>
                                            <td>
                                                <small>{{ rule.description or 'No description provided' }}</small>
                                            </td>
                                            <td>
                                                <span class="badge bg-{% if rule.priority >= 75 %}danger{% elif rule.priority >= 50 %}warning{% else %}secondary{% endif %}">
                                                    {{ rule.priority }}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-{% if rule.is_active %}success{% else %}secondary{% endif %}">
                                                    {% if rule.is_active %}Active{% else %}Inactive{% endif %}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" onclick="editRule({{ rule.id }})">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-secondary" onclick="toggleRule({{ rule.id }})">
                                                        <i class="fas fa-{% if rule.is_active %}pause{% else %}play{% endif %}"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="deleteRule({{ rule.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">No security rules found. Create your first rule using the button above.</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Exclusion Rules Tab -->
                    <div class="tab-pane fade" id="exclusion" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Rule Name</th>
                                        <th>Description</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if exclusion_rules %}
                                        {% for rule in exclusion_rules %}
                                        <tr>
                                            <td>
                                                <strong>{{ rule.name }}</strong>
                                                <br><small class="text-muted">{{ rule.description or 'No description' }}</small>
                                            </td>
                                            <td>
                                                <small>{{ rule.description or 'No description provided' }}</small>
                                            </td>
                                            <td>
                                                <span class="badge bg-{% if rule.priority >= 75 %}danger{% elif rule.priority >= 50 %}warning{% else %}secondary{% endif %}">
                                                    {{ rule.priority }}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-{% if rule.is_active %}success{% else %}secondary{% endif %}">
                                                    {% if rule.is_active %}Active{% else %}Inactive{% endif %}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" onclick="editRule({{ rule.id }})">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-secondary" onclick="toggleRule({{ rule.id }})">
                                                        <i class="fas fa-{% if rule.is_active %}pause{% else %}play{% endif %}"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="deleteRule({{ rule.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">No exclusion rules found. Create your first exclusion rule using the button above.</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Rule Modal -->
<div class="modal fade" id="newRuleModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>
                    Create New Security Rule
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newRuleForm">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Rule Name</label>
                                <input type="text" class="form-control" id="ruleName" placeholder="Enter rule name" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Rule Type</label>
                                <select class="form-select" id="ruleType" required>
                                    <option value="security">Security Rule</option>
                                    <option value="exclusion">Exclusion Rule</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="ruleCategory">
                                    <option value="security">Security</option>
                                    <option value="content">Content Filter</option>
                                    <option value="sender">Sender Rule</option>
                                    <option value="time">Time-based</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Rule Builder -->
                    <div class="mb-4">
                        <label class="form-label">Rule Conditions</label>
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">Complex Rule Builder</h6>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addCondition()">
                                        <i class="fas fa-plus"></i> Add Condition
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="conditionsContainer">
                                    <!-- Conditions will be added here dynamically -->
                                    <div class="condition-group" data-group="0">
                                        <div class="row mb-2">
                                            <div class="col-md-3">
                                                <select class="form-select condition-field">
                                                    <option value="sender">Sender Email</option>
                                                    <option value="subject">Subject</option>
                                                    <option value="recipients">Recipients</option>
                                                    <option value="attachments">Attachments</option>
                                                    <option value="recipients_email_domain">Recipient Domain</option>
                                                    <option value="wordlist_attachment">Attachment Keywords</option>
                                                    <option value="wordlist_subject">Subject Keywords</option>
                                                    <option value="bunit">Business Unit</option>
                                                    <option value="department">Department</option>
                                                    <option value="status">Status</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <select class="form-select condition-operator">
                                                    <option value="contains">contains</option>
                                                    <option value="equals">equals</option>
                                                    <option value="starts_with">starts with</option>
                                                    <option value="ends_with">ends with</option>
                                                    <option value="regex">regex match</option>
                                                    <option value="not_contains">not contains</option>
                                                    <option value="not_equals">not equals</option>
                                                    <option value="greater_than">greater than</option>
                                                    <option value="less_than">less than</option>
                                                    <option value="in_list">in list</option>
                                                    <option value="is_empty">is empty</option>
                                                    <option value="is_not_empty">is not empty</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <input type="text" class="form-control condition-value" placeholder="Enter value or regex pattern">
                                                <small class="text-muted">For regex: use patterns like .*urgent.*|.*confidential.*</small>
                                            </div>
                                            <div class="col-md-2">
                                                <select class="form-select condition-logic">
                                                    <option value="AND">AND</option>
                                                    <option value="OR">OR</option>
                                                </select>
                                            </div>
                                            <div class="col-md-1">
                                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeCondition(this)" disabled>
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Logic Preview -->
                                <div class="mt-3">
                                    <label class="form-label">Rule Logic Preview:</label>
                                    <div class="form-control bg-light" id="rulePreview" style="min-height: 60px; font-family: monospace;">
                                        sender contains ""
                                    </div>
                                </div>

                                <!-- Test Rule -->
                                <div class="mt-3">
                                    <button type="button" class="btn btn-outline-info" onclick="testRule()">
                                        <i class="fas fa-flask"></i> Test Rule Logic
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary ms-2" onclick="addConditionGroup()">
                                        <i class="fas fa-layer-group"></i> Add Group
                                    </button>
                                    <small class="text-muted ms-2">Test your rule syntax before saving</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="ruleDescription" rows="2" placeholder="Describe what this rule does"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Priority</label>
                                <select class="form-select" id="rulePriority">
                                    <option value="100">Critical (100)</option>
                                    <option value="75">High (75)</option>
                                    <option value="50" selected>Medium (50)</option>
                                    <option value="25">Low (25)</option>
                                    <option value="10">Minimal (10)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Action</label>
                                <select class="form-select" id="ruleAction">
                                    <option value="flag">Flag for Review</option>
                                    <option value="escalate">Escalate</option>
                                    <option value="block">Block/Exclude</option>
                                    <option value="monitor">Monitor</option>
                                    <option value="alert">Send Alert</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="ruleActive" checked>
                        <label class="form-check-label">Activate rule immediately</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNewRule()">
                    <i class="fas fa-save me-2"></i>
                    Create Rule
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function editRule(ruleId) {
    showAlert(`Editing rule ${ruleId}`, 'info');
}

function toggleRule(ruleId) {
    fetch(`/api/rules/${ruleId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ is_active: null }) // Server will toggle
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Rule status updated successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error updating rule: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error updating rule: ' + error.message, 'danger');
    });
}

function deleteRule(ruleId) {
    if (confirm('Are you sure you want to delete this rule? This action cannot be undone.')) {
        fetch(`/api/rules/${ruleId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Rule deleted successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert('Error deleting rule: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            showAlert('Error deleting rule: ' + error.message, 'danger');
        });
    }
}

function importRules() {
    showAlert('Rules imported successfully!', 'success');
}

function exportRules() {
    showAlert('Rules exported to downloads folder!', 'info');
}

let conditionCounter = 0;

function addCondition() {
    conditionCounter++;
    const container = document.getElementById('conditionsContainer');
    const newCondition = `
        <div class="condition-group" data-group="${conditionCounter}">
            <div class="row mb-2">
                <div class="col-md-3">
                    <select class="form-select condition-field">
                        <option value="sender">Sender Email</option>
                        <option value="subject">Subject</option>
                        <option value="recipients">Recipients</option>
                        <option value="attachments">Attachments</option>
                        <option value="recipients_email_domain">Recipient Domain</option>
                        <option value="wordlist_attachment">Attachment Keywords</option>
                        <option value="wordlist_subject">Subject Keywords</option>
                        <option value="bunit">Business Unit</option>
                        <option value="department">Department</option>
                        <option value="status">Status</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select condition-operator">
                        <option value="contains">contains</option>
                        <option value="equals">equals</option>
                        <option value="starts_with">starts with</option>
                        <option value="ends_with">ends with</option>
                        <option value="regex">regex match</option>
                        <option value="not_contains">not contains</option>
                        <option value="not_equals">not equals</option>
                        <option value="greater_than">greater than</option>
                        <option value="less_than">less than</option>
                        <option value="in_list">in list</option>
                        <option value="is_empty">is empty</option>
                        <option value="is_not_empty">is not empty</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control condition-value" placeholder="Enter value or regex pattern">
                    <small class="text-muted">For regex: use patterns like .*urgent.*|.*confidential.*</small>
                </div>
                <div class="col-md-2">
                    <select class="form-select condition-logic">
                        <option value="AND">AND</option>
                        <option value="OR">OR</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeCondition(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', newCondition);
    updateRulePreview();
    updateRemoveButtons();
}

function removeCondition(button) {
    const conditionGroup = button.closest('.condition-group');
    conditionGroup.remove();
    updateRulePreview();
    updateRemoveButtons();
}

function updateRemoveButtons() {
    const conditions = document.querySelectorAll('.condition-group');
    conditions.forEach((condition, index) => {
        const removeBtn = condition.querySelector('button[onclick*="removeCondition"]');
        if (conditions.length === 1) {
            removeBtn.disabled = true;
        } else {
            removeBtn.disabled = false;
        }
    });
}

function updateRulePreview() {
    const conditions = document.querySelectorAll('.condition-group');
    let preview = '';

    conditions.forEach((condition, index) => {
        const field = condition.querySelector('.condition-field').value;
        const operator = condition.querySelector('.condition-operator').value;
        const value = condition.querySelector('.condition-value').value || '""';
        const logic = condition.querySelector('.condition-logic').value;

        if (index > 0) {
            preview += ` ${logic} `;
        }

        if (operator === 'regex') {
            preview += `${field} ${operator} "${value}"`;
        } else {
            preview += `${field} ${operator} "${value}"`;
        }
    });

    document.getElementById('rulePreview').textContent = preview || 'No conditions defined';
}

function testRule() {
    const preview = document.getElementById('rulePreview').textContent;
    if (preview === 'No conditions defined' || preview.includes('""')) {
        showAlert('Please complete all condition values before testing.', 'warning');
        return;
    }

    // Validate regex patterns
    const conditions = document.querySelectorAll('.condition-group');
    let validationErrors = [];

    conditions.forEach((condition, index) => {
        const operator = condition.querySelector('.condition-operator').value;
        const value = condition.querySelector('.condition-value').value;

        if (operator === 'regex' && value) {
            try {
                new RegExp(value);
            } catch (e) {
                validationErrors.push(`Condition ${index + 1}: Invalid regex pattern - ${e.message}`);
            }
        }
    });

    if (validationErrors.length > 0) {
        showAlert('Rule validation failed:\\n' + validationErrors.join('\\n'), 'danger');
    } else {
        showAlert('Rule syntax is valid! âœ“', 'success');
    }
}

function addConditionGroup() {
    showAlert('Nested condition groups coming in future update!', 'info');
}

function buildRuleConditions() {
    const conditions = document.querySelectorAll('.condition-group');
    const conditionArray = [];

    conditions.forEach((condition) => {
        const field = condition.querySelector('.condition-field').value;
        const operator = condition.querySelector('.condition-operator').value;
        const value = condition.querySelector('.condition-value').value;
        const logic = condition.querySelector('.condition-logic').value;

        conditionArray.push({
            field: field,
            operator: operator,
            value: value,
            logic: logic
        });
    });

    return {
        logic: 'AND', // Default group logic
        conditions: conditionArray
    };
}

function saveNewRule() {
    const ruleName = document.getElementById('ruleName').value;
    const ruleType = document.getElementById('ruleType').value;
    const ruleCategory = document.getElementById('ruleCategory').value;
    const ruleDescription = document.getElementById('ruleDescription').value;
    const rulePriority = document.getElementById('rulePriority').value;
    const ruleAction = document.getElementById('ruleAction').value;
    const ruleActive = document.getElementById('ruleActive').checked;

    if (!ruleName.trim()) {
        showAlert('Please enter a rule name.', 'danger');
        return;
    }

    const conditions = buildRuleConditions();

    // Check if all conditions have values
    let hasEmptyConditions = false;
    conditions.conditions.forEach(condition => {
        if (!condition.value.trim() && !['is_empty', 'is_not_empty'].includes(condition.operator)) {
            hasEmptyConditions = true;
        }
    });

    if (hasEmptyConditions) {
        showAlert('Please complete all condition values.', 'danger');
        return;
    }

    const ruleData = {
        name: ruleName,
        rule_type: ruleType,
        category: ruleCategory,
        description: ruleDescription,
        priority: parseInt(rulePriority),
        actions: ruleAction,
        conditions: JSON.stringify(conditions),
        is_active: ruleActive
    };

    // Send to server
    fetch('/api/rules', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(ruleData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('New rule created successfully!', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('newRuleModal'));
            modal.hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error creating rule: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error creating rule: ' + error.message, 'danger');
    });
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);

    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

// Initialize event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Update preview when any condition changes
    document.addEventListener('change', function(e) {
        if (e.target.matches('.condition-field, .condition-operator, .condition-logic')) {
            updateRulePreview();
        }
    });

    document.addEventListener('input', function(e) {
        if (e.target.matches('.condition-value')) {
            updateRulePreview();
        }
    });

    // Initialize first condition
    updateRulePreview();
    updateRemoveButtons();
    
    // Only try to load whitelist domains if the whitelist table exists on this page
    if (document.querySelector('#whitelistTable')) {
        loadWhitelistDomains();
    }
});

// Whitelist Management Functions
function loadWhitelistDomains() {
    const tbody = document.querySelector('#whitelistTable tbody');
    if (!tbody) {
        console.log('Whitelist table not found on this page, skipping whitelist loading');
        return;
    }
    
    fetch('/api/whitelist-domains')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No whitelist domains configured</td></tr>';
                return;
            }

            data.forEach(domain => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${domain.domain}</strong></td>
                    <td><span class="badge bg-primary">${domain.domain_type}</span></td>
                    <td>${domain.added_by || 'System'}</td>
                    <td>${new Date(domain.added_at).toLocaleDateString()}</td>
                    <td>
                        <span class="badge bg-${domain.is_active ? 'success' : 'secondary'}">
                            ${domain.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" onclick="editWhitelistDomain(${domain.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-${domain.is_active ? 'warning' : 'success'}" 
                                    onclick="toggleWhitelistDomain(${domain.id})" 
                                    title="${domain.is_active ? 'Deactivate' : 'Activate'}">
                                <i class="fas fa-${domain.is_active ? 'pause' : 'play'}"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteWhitelistDomain(${domain.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error loading whitelist domains:', error);
            // Only show error if we're on a page that should have whitelist domains
            const tbody = document.querySelector('#whitelistTable tbody');
            if (tbody) {
                showError('Failed to load whitelist domains: ' + error.message);
            }
        });
}

// Add whitelist domain
document.getElementById('addWhitelistForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const domain = document.getElementById('domainInput').value.trim();
    const domainType = document.getElementById('domainType').value;
    const notes = document.getElementById('domainNotes').value.trim();

    if (!domain) {
        showError('Please enter a domain');
        return;
    }

    fetch('/api/whitelist-domains', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            domain: domain,
            domain_type: domainType,
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            bootstrap.Modal.getInstance(document.getElementById('addWhitelistModal')).hide();
            document.getElementById('addWhitelistForm').reset();
            loadWhitelistDomains();
        } else {
            showError(data.message);
        }
    })
    .catch(error => {
        console.error('Error adding whitelist domain:', error);
        showError('Failed to add whitelist domain');
    });
});

// Edit whitelist domain
function editWhitelistDomain(domainId) {
    fetch(`/api/whitelist-domains/${domainId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('editDomainId').value = data.id;
            document.getElementById('editDomainInput').value = data.domain;
            document.getElementById('editDomainType').value = data.domain_type;
            document.getElementById('editDomainNotes').value = data.notes || '';

            const modal = new bootstrap.Modal(document.getElementById('editWhitelistModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error loading domain details:', error);
            showError('Failed to load domain details');
        });
}

// Update whitelist domain
document.getElementById('editWhitelistForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const domainId = document.getElementById('editDomainId').value;
    const domainType = document.getElementById('editDomainType').value;
    const notes = document.getElementById('editDomainNotes').value.trim();

    fetch(`/api/whitelist-domains/${domainId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            domain_type: domainType,
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            bootstrap.Modal.getInstance(document.getElementById('editWhitelistModal')).hide();
            loadWhitelistDomains();
        } else {
            showError(data.message);
        }
    })
    .catch(error => {
        console.error('Error updating whitelist domain:', error);
        showError('Failed to update whitelist domain');
    });
});

// Toggle whitelist domain status
function toggleWhitelistDomain(domainId) {
    fetch(`/api/whitelist-domains/${domainId}/toggle`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            loadWhitelistDomains();
        } else {
            showError(data.message);
        }
    })
    .catch(error => {
        console.error('Error toggling whitelist domain:', error);
        showError('Failed to toggle whitelist domain');
    });
}

// Delete whitelist domain
function deleteWhitelistDomain(domainId) {
    if (confirm('Are you sure you want to delete this whitelist domain?')) {
        fetch(`/api/whitelist-domains/${domainId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(data.message);
                loadWhitelistDomains();
            } else {
                showError(data.message);
            }
        })
        .catch(error => {
            console.error('Error deleting whitelist domain:', error);
            showError('Failed to delete whitelist domain');
        });
    }
}

function showSuccess(message) {
    showAlert(message, 'success');
}

function showError(message) {
    showAlert(message, 'danger');
}
</script>
{% endblock %}