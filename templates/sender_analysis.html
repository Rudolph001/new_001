{% extends "base.html" %}

{% block title %}Sender Analysis - Session {{ session.id[:8] }}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Upload</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('dashboard', session_id=session.id) }}">Dashboard</a></li>
<li class="breadcrumb-item active">Sender Analysis</li>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h2">
                <i class="fas fa-user-friends text-primary"></i>
                Sender Behavior Analysis
            </h1>
            <div class="session-info">
                <span class="badge bg-primary fs-6">{{ session.filename }}</span>
                <span class="badge bg-info fs-6">{{ analysis.total_senders or 0 }} senders analyzed</span>
            </div>
        </div>
    </div>
</div>

<!-- Summary Statistics -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="card stats-card bg-gradient-primary text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div>
                        <h3 class="mb-0" id="totalSenders">{{ analysis.total_senders or 0 }}</h3>
                        <p class="mb-0">Total Senders</p>
                    </div>
                    <div class="ms-auto">
                        <i class="fas fa-users fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="card stats-card bg-gradient-danger text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div>
                        <h3 class="mb-0" id="highRiskSenders">{{ analysis.summary_statistics.high_risk_senders or 0 }}</h3>
                        <p class="mb-0">High Risk Senders</p>
                    </div>
                    <div class="ms-auto">
                        <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="card stats-card bg-gradient-warning text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div>
                        <h3 class="mb-0">{{ analysis.summary_statistics.external_focused_senders or 0 }}</h3>
                        <p class="mb-0">External Focused</p>
                    </div>
                    <div class="ms-auto">
                        <i class="fas fa-external-link-alt fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="card stats-card bg-gradient-success text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div>
                        <h3 class="mb-0">{{ "%.1f"|format(analysis.summary_statistics.avg_emails_per_sender or 0) }}</h3>
                        <p class="mb-0">Avg Emails/Sender</p>
                    </div>
                    <div class="ms-auto">
                        <i class="fas fa-chart-line fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Analysis Overview -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="card stats-card bg-gradient-warning text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div>
                        <h3 class="mb-0">{{ analysis.summary_statistics.critical_risk_senders or 0 }}</h3>
                        <p class="mb-0">Critical Risk Senders</p>
                    </div>
                    <div class="ms-auto">
                        <i class="fas fa-exclamation-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="card stats-card bg-gradient-info text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div>
                        <h3 class="mb-0">{{ "%.0f"|format(analysis.summary_statistics.avg_trust_score or 0) }}</h3>
                        <p class="mb-0">Avg Trust Score</p>
                    </div>
                    <div class="ms-auto">
                        <i class="fas fa-shield-alt fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="card stats-card bg-gradient-secondary text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div>
                        <h3 class="mb-0">{{ analysis.summary_statistics.total_anomalies or 0 }}</h3>
                        <p class="mb-0">Anomalies Detected</p>
                    </div>
                    <div class="ms-auto">
                        <i class="fas fa-search fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="card stats-card bg-gradient-dark text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div>
                        <h3 class="mb-0">{{ analysis.summary_statistics.multi_domain_senders or 0 }}</h3>
                        <p class="mb-0">Multi-Domain Senders</p>
                    </div>
                    <div class="ms-auto">
                        <i class="fas fa-network-wired fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Analysis Content -->
<div class="row">
    <!-- Enhanced Sender Behavior Chart -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-scatter text-primary"></i>
                        Sender Behavioral Analysis
                    </h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="chartMode" id="riskVsVolume" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="riskVsVolume">Risk vs Volume</label>
                        <input type="radio" class="btn-check" name="chartMode" id="trustVsBehavior" autocomplete="off">
                        <label class="btn btn-outline-primary" for="trustVsBehavior">Trust vs Behavior</label>
                        <input type="radio" class="btn-check" name="chartMode" id="velocityVsSpread" autocomplete="off">
                        <label class="btn btn-outline-primary" for="velocityVsSpread">Velocity vs Spread</label>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="senderBehaviorChart"></canvas>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        <span id="chartDescription">Each point represents a sender. Click mode buttons to switch views. Hover over points for detailed information.</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Metrics Panel -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tachometer-alt text-primary"></i>
                    Behavioral Insights
                </h5>
            </div>
            <div class="card-body">
                {% if analysis.behavioral_insights %}
                <div class="mb-3">
                    <h6>Communication Patterns</h6>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">External Heavy:</small><br>
                            <span class="fw-bold text-warning">{{ analysis.behavioral_insights.communication_patterns.external_heavy or 0 }}</span>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Internal Heavy:</small><br>
                            <span class="fw-bold text-success">{{ analysis.behavioral_insights.communication_patterns.internal_heavy or 0 }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6>Risk Profiles</h6>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Consistently Risky:</small><br>
                            <span class="fw-bold text-danger">{{ analysis.behavioral_insights.risk_profiles.consistently_risky or 0 }}</span>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Low Risk Stable:</small><br>
                            <span class="fw-bold text-success">{{ analysis.behavioral_insights.risk_profiles.low_risk_stable or 0 }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6>Trust Distribution</h6>
                    <div class="progress mb-2">
                        {% set total_trust = (analysis.behavioral_insights.trust_distribution.high_trust or 0) + (analysis.behavioral_insights.trust_distribution.medium_trust or 0) + (analysis.behavioral_insights.trust_distribution.low_trust or 0) %}
                        {% if total_trust > 0 %}
                        <div class="progress-bar bg-success" style="width: {{ ((analysis.behavioral_insights.trust_distribution.high_trust or 0) / total_trust * 100)|int }}%"></div>
                        <div class="progress-bar bg-warning" style="width: {{ ((analysis.behavioral_insights.trust_distribution.medium_trust or 0) / total_trust * 100)|int }}%"></div>
                        <div class="progress-bar bg-danger" style="width: {{ ((analysis.behavioral_insights.trust_distribution.low_trust or 0) / total_trust * 100)|int }}%"></div>
                        {% endif %}
                    </div>
                    <div class="d-flex justify-content-between">
                        <small class="text-success">High: {{ analysis.behavioral_insights.trust_distribution.high_trust or 0 }}</small>
                        <small class="text-warning">Med: {{ analysis.behavioral_insights.trust_distribution.medium_trust or 0 }}</small>
                        <small class="text-danger">Low: {{ analysis.behavioral_insights.trust_distribution.low_trust or 0 }}</small>
                    </div>
                </div>
                {% endif %}
                
                <div class="mt-3">
                    <h6>Top Anomalies</h6>
                    {% if analysis.anomaly_summary and analysis.anomaly_summary.top_anomalies %}
                        {% for anomaly, count in (analysis.anomaly_summary.top_anomalies.items() | list)[:3] %}
                        <div class="d-flex justify-content-between mb-1">
                            <small class="text-muted">{{ anomaly[:25] }}{% if anomaly|length > 25 %}...{% endif %}</small>
                            <span class="badge bg-warning">{{ count }}</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <small class="text-muted">No significant anomalies detected</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Analytics Row -->
<div class="row mb-4">
    <!-- Risk Patterns Analysis -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar text-primary"></i>
                    Risk Pattern Correlations
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container chart-small">
                    <canvas id="riskPatternsChart"></canvas>
                </div>
                <div class="mt-3">
                    {% if analysis.risk_patterns %}
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">High Risk + External:</small><br>
                            <span class="fw-bold text-danger">{{ analysis.risk_patterns.high_risk_external or 0 }}</span>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">High Risk + Attachments:</small><br>
                            <span class="fw-bold text-warning">{{ analysis.risk_patterns.high_risk_attachments or 0 }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Temporal Behavior Analysis -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clock text-primary"></i>
                    Temporal Behavior Patterns
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container chart-small">
                    <canvas id="temporalPatternsChart"></canvas>
                </div>
                <div class="mt-3">
                    {% if analysis.behavioral_insights and analysis.behavioral_insights.temporal_patterns %}
                    <div class="row">
                        <div class="col-4 text-center">
                            <div class="border rounded p-2">
                                <strong class="text-success">{{ analysis.behavioral_insights.temporal_patterns.business_hours_only or 0 }}</strong><br>
                                <small class="text-muted">Business Hours Only</small>
                            </div>
                        </div>
                        <div class="col-4 text-center">
                            <div class="border rounded p-2">
                                <strong class="text-warning">{{ analysis.behavioral_insights.temporal_patterns.after_hours_active or 0 }}</strong><br>
                                <small class="text-muted">After Hours Active</small>
                            </div>
                        </div>
                        <div class="col-4 text-center">
                            <div class="border rounded p-2">
                                <strong class="text-info">{{ analysis.behavioral_insights.temporal_patterns.weekend_active or 0 }}</strong><br>
                                <small class="text-muted">Weekend Active</small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Top Risk Senders Table -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-user-shield text-danger"></i>
                High Risk Senders
            </h5>
            <button class="btn btn-outline-primary btn-sm" onclick="exportSenderAnalysis()">
                <i class="fas fa-download"></i> Export Analysis
            </button>
        </div>
    </div>
    <div class="card-body">
        {% if analysis.sender_profiles %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Sender</th>
                        <th>Volume</th>
                        <th>Risk Analysis</th>
                        <th>Trust Score</th>
                        <th>Communication Pattern</th>
                        <th>Behavioral Flags</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sender, profile in (analysis.sender_profiles.items() | list)[:25] %}
                    <tr class="{% if profile.critical_risk_emails > 0 %}table-danger{% elif profile.risk_score_avg > 0.6 %}table-warning{% endif %}">
                        <td>
                            <div>
                                <strong>{{ sender[:25] }}{% if sender|length > 25 %}...{% endif %}</strong>
                                {% if profile.leaver_emails > 0 %}
                                <span class="badge bg-danger ms-1">LEAVER</span>
                                {% endif %}
                                {% if profile.risk_trend == 'increasing' %}
                                <i class="fas fa-arrow-up text-danger ms-1" title="Risk Increasing"></i>
                                {% elif profile.risk_trend == 'decreasing' %}
                                <i class="fas fa-arrow-down text-success ms-1" title="Risk Decreasing"></i>
                                {% endif %}
                            </div>
                            <small class="text-muted">
                                {{ "%.1f"|format(profile.communication_velocity) }} emails/day
                            </small>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-info">{{ profile.total_emails }}</span>
                                <div class="ms-2">
                                    {% if profile.attachments_sent > 0 %}
                                    <i class="fas fa-paperclip text-secondary" title="{{ profile.attachments_sent }} attachments"></i>
                                    {% endif %}
                                    {% if profile.recipient_spread > 10 %}
                                    <i class="fas fa-network-wired text-warning" title="{{ profile.recipient_spread }} domains"></i>
                                    {% endif %}
                                </div>
                            </div>
                            <small class="text-muted">
                                {{ profile.recipient_spread }} domains
                            </small>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="fw-bold {% if profile.risk_score_avg > 0.7 %}text-danger{% elif profile.risk_score_avg > 0.4 %}text-warning{% else %}text-success{% endif %}">
                                    {{ "%.3f"|format(profile.risk_score_avg) }}
                                </span>
                                <div class="progress ms-2" style="width: 50px; height: 6px;">
                                    <div class="progress-bar bg-{% if profile.risk_score_avg > 0.7 %}danger{% elif profile.risk_score_avg > 0.4 %}warning{% else %}success{% endif %}" 
                                         style="width: {{ (profile.risk_score_avg * 100)|int }}%"></div>
                                </div>
                            </div>
                            <small class="text-muted">
                                {% if profile.critical_risk_emails > 0 %}
                                <span class="text-danger">{{ profile.critical_risk_emails }} critical</span>
                                {% elif profile.high_risk_emails > 0 %}
                                <span class="text-warning">{{ profile.high_risk_emails }} high risk</span>
                                {% else %}
                                <span class="text-success">Low risk</span>
                                {% endif %}
                            </small>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="fw-bold {% if profile.trust_score >= 80 %}text-success{% elif profile.trust_score >= 50 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ "%.0f"|format(profile.trust_score) }}
                                </span>
                                <div class="progress ms-2" style="width: 50px; height: 6px;">
                                    <div class="progress-bar bg-{% if profile.trust_score >= 80 %}success{% elif profile.trust_score >= 50 %}warning{% else %}danger{% endif %}" 
                                         style="width: {{ profile.trust_score|int }}%"></div>
                                </div>
                            </div>
                            <small class="text-muted">
                                Behavioral: {{ "%.0f"|format(profile.behavioral_score) }}
                            </small>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="{% if profile.external_ratio > 0.8 %}text-danger{% elif profile.external_ratio > 0.5 %}text-warning{% else %}text-success{% endif %}">
                                    {{ "%.0f"|format(profile.external_ratio * 100) }}% ext
                                </span>
                            </div>
                            <small class="text-muted">
                                {% if profile.after_hours_emails > 0 %}
                                <i class="fas fa-moon text-warning" title="After hours activity"></i>
                                {% endif %}
                                {% if profile.weekend_emails > 0 %}
                                <i class="fas fa-calendar text-info" title="Weekend activity"></i>
                                {% endif %}
                                {% if profile.risk_variance > 0.3 %}
                                <i class="fas fa-exclamation-triangle text-warning" title="Inconsistent risk"></i>
                                {% endif %}
                            </small>
                        </td>
                        <td>
                            {% if profile.behavior_flags %}
                                {% for flag in profile.behavior_flags[:2] %}
                                    <div class="badge bg-{% if '🔴' in flag %}danger{% elif '⚠️' in flag or '🟡' in flag %}warning{% elif '✅' in flag %}success{% else %}secondary{% endif %} mb-1" style="font-size: 0.7em;">
                                        {{ flag[:35] }}{% if flag|length > 35 %}...{% endif %}
                                    </div><br>
                                {% endfor %}
                                {% if profile.behavior_flags|length > 2 %}
                                    <small class="text-muted">+{{ profile.behavior_flags|length - 2 }} more</small>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Normal behavior</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary" onclick="viewSenderDetails('{{ sender }}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="analyzeSenderCommunications('{{ sender }}')" title="Analyze Communications">
                                    <i class="fas fa-search"></i>
                                </button>
                                {% if profile.risk_score_avg > 0.6 or profile.trust_score < 50 %}
                                <button class="btn btn-outline-danger" onclick="flagSender('{{ sender }}')" title="Flag for Review">
                                    <i class="fas fa-flag"></i>
                                </button>
                                {% endif %}
                                {% if profile.anomaly_indicators %}
                                <button class="btn btn-outline-warning" onclick="viewAnomalies('{{ sender }}')" title="View Anomalies">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-user-friends fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No Sender Data Available</h5>
            <p class="text-muted">Sender analysis will be available after processing is complete.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Communication Patterns -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-network-wired text-primary"></i>
                    Communication Patterns
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container chart-small">
                    <canvas id="communicationPatternsChart"></canvas>
                </div>
                <div class="mt-3">
                    <h6>Pattern Analysis:</h6>
                    <ul class="list-unstyled">
                        <li class="d-flex justify-content-between">
                            <span>High Volume Senders:</span>
                            <span class="fw-bold">{{ analysis.sender_profiles.values()|selectattr('total_emails', 'gt', 10)|list|length if analysis.sender_profiles else 0 }}</span>
                        </li>
                        <li class="d-flex justify-content-between">
                            <span>Multi-Domain Communicators:</span>
                            <span class="fw-bold">{{ analysis.sender_profiles.values()|selectattr('domains_contacted')|list|length if analysis.sender_profiles else 0 }}</span>
                        </li>
                        <li class="d-flex justify-content-between">
                            <span>Suspicious Patterns:</span>
                            <span class="fw-bold text-warning">{{ analysis.sender_profiles.values()|selectattr('behavior_flags')|list|length if analysis.sender_profiles else 0 }}</span>
                        </li>
                    </ul>
                </div>
                
                <div class="mt-3">
                    <h6>ML Keywords Used:</h6>
                    <button class="btn btn-outline-info btn-sm w-100" onclick="showMLKeywords()">
                        <i class="fas fa-tags"></i> View Active Keywords
                    </button>
                    <div id="mlKeywordsResult" style="display: none;" class="mt-2 p-2 bg-light border rounded">
                        <!-- Keywords will be loaded here -->
                    </div>
                    <div id="mlKeywords" class="mt-2" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clipboard-list text-primary"></i>
                    Risk Recommendations
                </h5>
            </div>
            <div class="card-body">
                <div class="recommendations">
                    {% if analysis.sender_profiles %}
                        {% set high_risk_senders = analysis.sender_profiles.values()|selectattr('risk_score_avg', 'gt', 0.7)|list %}
                        {% set external_senders = analysis.sender_profiles.values()|selectattr('external_ratio', 'gt', 0.8)|list %}
                        
                        {% if analysis.sender_profiles %}
                        {% set high_risk_senders = analysis.sender_profiles.values()|selectattr('risk_score_avg', 'gt', 0.7)|list %}
                        {% set external_senders = analysis.sender_profiles.values()|selectattr('external_ratio', 'gt', 0.8)|list %}
                        
                        {% if high_risk_senders %}
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle"></i> High Priority</h6>
                            <p class="mb-1">{{ high_risk_senders|length }} senders have high risk scores (>0.7)</p>
                            <small>Immediate review recommended for security assessment</small>
                        </div>
                        {% endif %}
                        
                        {% if external_senders %}
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-external-link-alt"></i> External Communication</h6>
                            <p class="mb-1">{{ external_senders|length }} senders primarily communicate externally</p>
                            <small>Review external communication policies and monitoring</small>
                        </div>
                        {% endif %}
                        {% endif %}
                        
                        <div class="alert alert-info">
                            <h6><i class="fas fa-shield-alt"></i> Security Recommendations</h6>
                            <ul class="mb-0">
                                <li>Monitor high-volume external communicators</li>
                                <li>Review senders with multiple domain contacts</li>
                                <li>Implement additional controls for flagged behavior patterns</li>
                                <li>Regular review of sender risk scores and trends</li>
                            </ul>
                        </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-info-circle fa-2x text-info mb-2"></i>
                        <p class="text-muted">Recommendations will be available after analysis completion</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sender Details Modal -->
<div class="modal fade" id="senderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sender Analysis Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="senderDetailsBody">
                <!-- Sender details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportSenderReport()">Export Report</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Set session ID for JavaScript functions
window.currentSessionId = '{{ session.id }}';

// Function to fetch sender analysis data from API
function fetchSenderAnalysisData() {
    console.log('Fetching sender analysis data from API...');
    fetch(`/api/sender-analysis/${window.currentSessionId}`)
        .then(response => response.json())
        .then(data => {
            console.log('API response:', data);
            if (data && !data.error && data.sender_profiles && Object.keys(data.sender_profiles).length > 0) {
                senderAnalysisData = data;
                // Update the display with new data
                updateSenderAnalysisDisplay(data);
                // Create the chart
                createSenderChart('riskVsVolume');
            } else {
                console.warn('No sender data available from API:', data);
                showNoDataMessage();
            }
        })
        .catch(error => {
            console.error('Error fetching sender analysis:', error);
            showNoDataMessage();
        });
}

function updateSenderAnalysisDisplay(data) {
    // Update statistics
    document.getElementById('totalSenders').textContent = data.total_senders || 0;
    
    if (data.summary_statistics) {
        const stats = data.summary_statistics;
        const elements = {
            'highRiskSenders': stats.high_risk_senders || 0,
            'criticalRiskSenders': stats.critical_risk_senders || 0,
            'avgTrustScore': Math.round(stats.avg_trust_score || 0),
            'totalAnomalies': stats.total_anomalies || 0,
            'multiDomainSenders': stats.multi_domain_senders || 0
        };
        
        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
        });
        
        // Update average emails per sender
        const avgElement = document.querySelector('h3:contains("Avg Emails/Sender")');
        if (avgElement) {
            avgElement.textContent = (stats.avg_emails_per_sender || 0).toFixed(1);
        }
    }
}

function showNoDataMessage() {
    const behaviorCtx = document.getElementById('senderBehaviorChart');
    if (behaviorCtx) {
        const ctx = behaviorCtx.getContext('2d');
        ctx.clearRect(0, 0, behaviorCtx.width, behaviorCtx.height);
        ctx.font = '16px Arial';
        ctx.fillStyle = '#666';
        ctx.textAlign = 'center';
        ctx.fillText('No sender data available for analysis', behaviorCtx.width / 2, behaviorCtx.height / 2);
    }
}

// Initialize sender analysis charts
document.addEventListener('DOMContentLoaded', function() {
    // Create sender risk distribution chart
    const riskCtx = document.getElementById('senderRiskDistributionChart');
    if (riskCtx) {
        new Chart(riskCtx, {
            type: 'doughnut',
            data: {
                labels: ['High Risk', 'Medium Risk', 'Low Risk'],
                datasets: [{
                    data: [
                        {{ analysis.summary_statistics.high_risk_senders or 0 }},
                        {{ (analysis.total_senders or 0) - (analysis.summary_statistics.high_risk_senders or 0) - ((analysis.total_senders or 0) * 0.3)|int }},
                        {{ ((analysis.total_senders or 0) * 0.3)|int }}
                    ],
                    backgroundColor: ['#dc3545', '#ffc107', '#198754'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Enhanced sender behavior scatter plot with multiple modes
    const behaviorCtx = document.getElementById('senderBehaviorChart');
    let senderChart = null;
    let senderAnalysisData = {{ analysis | tojson }};
    
    console.log('Sender analysis data:', senderAnalysisData);
    
    if (behaviorCtx && senderAnalysisData && senderAnalysisData.sender_profiles && Object.keys(senderAnalysisData.sender_profiles).length > 0) {
        createSenderChart('riskVsVolume'); // Default mode
        
        // Add event listeners for chart mode switching
        document.querySelectorAll('input[name="chartMode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    createSenderChart(this.id);
                }
            });
        });
    } else if (behaviorCtx) {
        // Show message when no data is available
        const ctx = behaviorCtx.getContext('2d');
        ctx.font = '16px Arial';
        ctx.fillStyle = '#666';
        ctx.textAlign = 'center';
        ctx.fillText('Error loading chart data', behaviorCtx.width / 2, behaviorCtx.height / 2);
        
        // Try to fetch data from API as fallback
        fetchSenderAnalysisData();
    }
    
    function createSenderChart(mode) {
        if (!senderAnalysisData || !senderAnalysisData.sender_profiles) {
            return;
        }
        
        // Destroy existing chart
        if (senderChart) {
            senderChart.destroy();
        }
        
        const senders = Object.entries(senderAnalysisData.sender_profiles).slice(0, 50); // Top 50 senders
        let chartData, xAxisLabel, yAxisLabel, description;
        
        switch (mode) {
            case 'trustVsBehavior':
                chartData = senders.map(([sender, profile]) => ({
                    x: profile.behavioral_score || 0,
                    y: profile.trust_score || 0,
                    sender: sender,
                    profile: profile
                }));
                xAxisLabel = 'Behavioral Score';
                yAxisLabel = 'Trust Score';
                description = 'Trust score vs behavioral score. Higher values indicate better behavior and higher trust.';
                break;
                
            case 'velocityVsSpread':
                chartData = senders.map(([sender, profile]) => ({
                    x: profile.communication_velocity || 0,
                    y: profile.recipient_spread || 0,
                    sender: sender,
                    profile: profile
                }));
                xAxisLabel = 'Communication Velocity (emails/day)';
                yAxisLabel = 'Recipient Spread (domains contacted)';
                description = 'Communication velocity vs recipient spread. High values may indicate bulk or automated communications.';
                break;
                
            default: // riskVsVolume
                chartData = senders.map(([sender, profile]) => ({
                    x: profile.total_emails || 0,
                    y: profile.risk_score_avg || 0,
                    sender: sender,
                    profile: profile
                }));
                xAxisLabel = 'Communication Volume (Total Emails)';
                yAxisLabel = 'Average Risk Score';
                description = 'Risk score vs communication volume. Points in upper right quadrant need immediate attention.';
                break;
        }
        
        // Update description
        document.getElementById('chartDescription').textContent = description;
        
        senderChart = new Chart(behaviorCtx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Senders',
                    data: chartData,
                    backgroundColor: function(context) {
                        const profile = context.raw.profile;
                        
                        // Color coding based on different criteria for different modes
                        if (mode === 'trustVsBehavior') {
                            if (profile.trust_score >= 80) return '#198754'; // High trust - green
                            if (profile.trust_score >= 50) return '#ffc107'; // Medium trust - yellow
                            return '#dc3545'; // Low trust - red
                        } else if (mode === 'velocityVsSpread') {
                            if (profile.communication_velocity > 10 && profile.recipient_spread > 20) return '#dc3545'; // High velocity + spread - red
                            if (profile.communication_velocity > 5 || profile.recipient_spread > 10) return '#ffc107'; // Medium - yellow
                            return '#198754'; // Normal - green
                        } else {
                            // Default risk-based coloring
                            if (profile.risk_score_avg > 0.7) return '#dc3545'; // High risk - red
                            if (profile.risk_score_avg > 0.4) return '#ffc107'; // Medium risk - yellow
                            return '#198754'; // Low risk - green
                        }
                    },
                    borderColor: function(context) {
                        return context.element.options.backgroundColor;
                    },
                    pointRadius: function(context) {
                        const profile = context.raw.profile;
                        
                        // Size based on different criteria
                        if (mode === 'trustVsBehavior') {
                            return Math.max(4, Math.min(15, (100 - profile.trust_score) / 10 + 3));
                        } else if (mode === 'velocityVsSpread') {
                            return Math.max(4, Math.min(15, profile.total_emails / 10 + 3));
                        } else {
                            return Math.max(4, Math.min(15, (profile.critical_risk_emails || 0) + 4));
                        }
                    },
                    pointHoverRadius: function(context) {
                        return context.element.options.pointRadius + 3;
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        title: {
                            display: true,
                            text: xAxisLabel
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: yAxisLabel
                        },
                        min: mode === 'riskVsVolume' ? 0 : undefined,
                        max: mode === 'riskVsVolume' ? 1 : undefined
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return context[0].raw.sender;
                            },
                            label: function(context) {
                                const profile = context.raw.profile;
                                const labels = [
                                    `Total Emails: ${profile.total_emails}`,
                                    `Risk Score: ${(profile.risk_score_avg || 0).toFixed(3)}`,
                                    `Trust Score: ${(profile.trust_score || 0).toFixed(0)}`,
                                    `External Ratio: ${((profile.external_ratio || 0) * 100).toFixed(1)}%`,
                                    `Domains: ${profile.recipient_spread || 0}`,
                                    `Velocity: ${(profile.communication_velocity || 0).toFixed(1)} emails/day`
                                ];
                                
                                if (profile.critical_risk_emails > 0) {
                                    labels.push(`Critical Risk Emails: ${profile.critical_risk_emails}`);
                                }
                                
                                if (profile.anomaly_indicators && profile.anomaly_indicators.length > 0) {
                                    labels.push(`Anomalies: ${profile.anomaly_indicators.length}`);
                                }
                                
                                return labels;
                            }
                        }
                    }
                },
                onClick: function(event, elements) {
                    if (elements.length > 0) {
                        const point = elements[0];
                        const senderData = chartData[point.index];
                        if (senderData && senderData.sender) {
                            viewSenderDetails(senderData.sender);
                        }
                    }
                }
            }
        });
    }
    
    // Create risk patterns chart
    const riskPatternsCtx = document.getElementById('riskPatternsChart');
    if (riskPatternsCtx && senderAnalysisData && senderAnalysisData.risk_patterns) {
        new Chart(riskPatternsCtx, {
            type: 'bar',
            data: {
                labels: ['High Risk +\nExternal', 'High Risk +\nAttachments', 'High Risk +\nVolume', 'High Risk +\nAfter Hours', 'Leaver Risk\nCorrelation'],
                datasets: [{
                    label: 'Sender Count',
                    data: [
                        senderAnalysisData.risk_patterns.high_risk_external || 0,
                        senderAnalysisData.risk_patterns.high_risk_attachments || 0,
                        senderAnalysisData.risk_patterns.high_risk_volume || 0,
                        senderAnalysisData.risk_patterns.high_risk_after_hours || 0,
                        senderAnalysisData.risk_patterns.leaver_risk_correlation || 0
                    ],
                    backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#6f42c1', '#e83e8c'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    
    // Create temporal patterns chart
    const temporalPatternsCtx = document.getElementById('temporalPatternsChart');
    if (temporalPatternsCtx && senderAnalysisData && senderAnalysisData.behavioral_insights) {
        const temporal = senderAnalysisData.behavioral_insights.temporal_patterns;
        new Chart(temporalPatternsCtx, {
            type: 'doughnut',
            data: {
                labels: ['Business Hours Only', 'After Hours Active', 'Weekend Active'],
                datasets: [{
                    data: [
                        temporal.business_hours_only || 0,
                        temporal.after_hours_active || 0,
                        temporal.weekend_active || 0
                    ],
                    backgroundColor: ['#198754', '#ffc107', '#0dcaf0'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            fontSize: 10
                        }
                    }
                }
            }
        });
    }
    
    // Create communication patterns chart
    const patternsCtx = document.getElementById('communicationPatternsChart');
    if (patternsCtx) {
        new Chart(patternsCtx, {
            type: 'bar',
            data: {
                labels: ['High Volume', 'External Focus', 'Multi-Domain', 'Attachments', 'Flagged'],
                datasets: [{
                    label: 'Sender Count',
                    data: [
                        {{ analysis.sender_profiles.values()|selectattr('total_emails', 'gt', 10)|list|length if analysis.sender_profiles else 0 }},
                        {{ analysis.summary_statistics.external_focused_senders or 0 }},
                        {{ analysis.sender_profiles.values()|selectattr('domains_contacted')|list|length if analysis.sender_profiles else 0 }},
                        {{ analysis.summary_statistics.attachment_senders or 0 }},
                        {{ analysis.sender_profiles.values()|selectattr('behavior_flags')|list|length if analysis.sender_profiles else 0 }}
                    ],
                    backgroundColor: ['#0d6efd', '#fd7e14', '#20c997', '#6f42c1', '#dc3545'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
});

function showMLKeywords() {
    const resultDiv = document.getElementById('mlKeywordsResult');
    const button = document.querySelector('button[onclick="showMLKeywords()"]');
    
    if (resultDiv.style.display === 'none') {
        // Show and load keywords
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-2">Loading ML keywords...</span>
            </div>
        `;
        
        button.innerHTML = '<i class="fas fa-tags"></i> Hide Keywords';
        
        // Fetch ML keywords from API
        fetch('/api/ml-keywords')
            .then(response => response.json())
            .then(data => {
                if (data.error && data.total_keywords === 0) {
                    resultDiv.innerHTML = `<div class="alert alert-info">${data.message || 'No ML keywords configured'}</div>`;
                    return;
                }
                
                let html = `
                    <div class="mb-2">
                        <strong>Total Keywords:</strong> ${data.total_keywords || 0} 
                        <span class="text-muted">(Last updated: ${new Date(data.last_updated).toLocaleDateString()})</span>
                    </div>
                    <div class="row mb-2">
                        <div class="col-4">
                            <span class="badge bg-success">Business: ${data.categories?.Business || 0}</span>
                        </div>
                        <div class="col-4">
                            <span class="badge bg-warning">Personal: ${data.categories?.Personal || 0}</span>
                        </div>
                        <div class="col-4">
                            <span class="badge bg-danger">Suspicious: ${data.categories?.Suspicious || 0}</span>
                        </div>
                    </div>
                `;
                
                if (data.keywords && data.keywords.length > 0) {
                    html += '<div class="row">';
                    data.keywords.slice(0, 20).forEach(keyword => {
                        const badgeClass = keyword.category === 'Business' ? 'success' : 
                                         keyword.category === 'Personal' ? 'warning' : 'danger';
                        html += `
                            <div class="col-6 mb-1">
                                <small class="d-flex justify-content-between">
                                    <span>${keyword.keyword}</span>
                                    <span class="badge bg-${badgeClass}">${keyword.risk_score}</span>
                                </small>
                            </div>
                        `;
                    });
                    html += '</div>';
                    
                    if (data.keywords.length > 20) {
                        html += `<small class="text-muted">Showing 20 of ${data.keywords.length} keywords</small>`;
                    }
                } else {
                    html += '<div class="text-muted">No ML keywords available. You can populate default keywords from the admin panel.</div>';
                }
                
                if (data.message) {
                    html += `<div class="alert alert-info mt-2">${data.message}</div>`;
                }
                
                resultDiv.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading ML keywords:', error);
                resultDiv.innerHTML = '<div class="alert alert-warning">Unable to load ML keywords at this time</div>';
            });
    } else {
        // Hide keywords
        resultDiv.style.display = 'none';
        button.innerHTML = '<i class="fas fa-tags"></i> View Active Keywords';
    }
}

function viewSenderDetails(senderEmail) {
    const modalBody = document.getElementById('senderDetailsBody');
    modalBody.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading sender details...</p>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('senderDetailsModal'));
    modal.show();
    
    // Find sender data from the current analysis
    const senderData = findSenderData(senderEmail);
    
    if (senderData) {
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-user text-primary"></i> Sender Profile</h6>
                    <p><strong>Email:</strong> ${senderEmail}</p>
                    <p><strong>Total Communications:</strong> <span class="badge bg-info">${senderData.total_emails}</span></p>
                    <p><strong>Communication Velocity:</strong> <span class="badge bg-secondary">${(senderData.communication_velocity || 0).toFixed(1)} emails/day</span></p>
                    <p><strong>Activity Period:</strong> 
                        ${senderData.first_seen ? new Date(senderData.first_seen).toLocaleDateString() : 'Unknown'} - 
                        ${senderData.last_seen ? new Date(senderData.last_seen).toLocaleDateString() : 'Unknown'}
                    </p>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-shield-alt text-success"></i> Trust & Risk Assessment</h6>
                    <p><strong>Trust Score:</strong> 
                        <span class="fw-bold ${senderData.trust_score >= 80 ? 'text-success' : senderData.trust_score >= 50 ? 'text-warning' : 'text-danger'}">
                            ${(senderData.trust_score || 0).toFixed(0)}/100
                        </span>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-${senderData.trust_score >= 80 ? 'success' : senderData.trust_score >= 50 ? 'warning' : 'danger'}" 
                                 style="width: ${senderData.trust_score || 0}%"></div>
                        </div>
                    </p>
                    <p><strong>Behavioral Score:</strong> 
                        <span class="fw-bold text-info">${(senderData.behavioral_score || 0).toFixed(0)}/100</span>
                    </p>
                    <p><strong>Risk Trend:</strong> 
                        <span class="badge bg-${senderData.risk_trend === 'increasing' ? 'danger' : senderData.risk_trend === 'decreasing' ? 'success' : 'secondary'}">
                            ${senderData.risk_trend || 'stable'}
                            ${senderData.risk_trend === 'increasing' ? '📈' : senderData.risk_trend === 'decreasing' ? '📉' : '➡️'}
                        </span>
                    </p>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-chart-line text-warning"></i> Risk Analysis</h6>
                    <p><strong>Average Risk Score:</strong> 
                        <span class="fw-bold ${senderData.risk_score_avg > 0.7 ? 'text-danger' : senderData.risk_score_avg > 0.4 ? 'text-warning' : 'text-success'}">
                            ${(senderData.risk_score_avg || 0).toFixed(3)}
                        </span>
                    </p>
                    <p><strong>Risk Distribution:</strong></p>
                    <ul class="list-unstyled ms-3">
                        <li><span class="text-danger">Critical:</span> ${senderData.critical_risk_emails || 0}</li>
                        <li><span class="text-warning">High:</span> ${senderData.high_risk_emails || 0}</li>
                        <li><span class="text-info">Medium:</span> ${senderData.medium_risk_emails || 0}</li>
                        <li><span class="text-success">Low:</span> ${senderData.low_risk_emails || 0}</li>
                    </ul>
                    <p><strong>Risk Consistency:</strong> 
                        <span class="badge bg-${(senderData.risk_consistency || 0) > 0.8 ? 'success' : (senderData.risk_consistency || 0) > 0.6 ? 'warning' : 'danger'}">
                            ${((senderData.risk_consistency || 0) * 100).toFixed(0)}%
                        </span>
                    </p>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-network-wired text-info"></i> Communication Patterns</h6>
                    <p><strong>External vs Internal:</strong></p>
                    <div class="progress mb-2" style="height: 20px;">
                        <div class="progress-bar bg-danger" style="width: ${((senderData.external_ratio || 0) * 100).toFixed(0)}%">
                            External ${((senderData.external_ratio || 0) * 100).toFixed(0)}%
                        </div>
                        <div class="progress-bar bg-success" style="width: ${((senderData.internal_ratio || 0) * 100).toFixed(0)}%">
                            Internal ${((senderData.internal_ratio || 0) * 100).toFixed(0)}%
                        </div>
                    </div>
                    <p><strong>Recipient Spread:</strong> <span class="badge bg-info">${senderData.recipient_spread || 0} domains</span></p>
                    <p><strong>Attachments:</strong> <span class="badge bg-secondary">${senderData.attachments_sent || 0} (${((senderData.attachment_ratio || 0) * 100).toFixed(0)}%)</span></p>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-clock text-secondary"></i> Temporal Patterns</h6>
                    <p><strong>Business Hours:</strong> ${senderData.business_hours_emails || 0}</p>
                    <p><strong>After Hours:</strong> <span class="${senderData.after_hours_emails > 0 ? 'text-warning' : 'text-muted'}">${senderData.after_hours_emails || 0}</span></p>
                    <p><strong>Weekend Activity:</strong> <span class="${senderData.weekend_emails > 0 ? 'text-info' : 'text-muted'}">${senderData.weekend_emails || 0}</span></p>
                    ${senderData.leaver_emails > 0 ? `<p><strong>⚠️ Leaver Communications:</strong> <span class="text-danger fw-bold">${senderData.leaver_emails}</span></p>` : ''}
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-exclamation-triangle text-warning"></i> Anomalies & Flags</h6>
                    ${senderData.anomaly_indicators && senderData.anomaly_indicators.length > 0 ? `
                    <p><strong>Detected Anomalies:</strong></p>
                    <ul class="list-unstyled">
                        ${senderData.anomaly_indicators.slice(0, 3).map(anomaly => `<li><span class="badge bg-warning me-1">⚠️</span> ${anomaly}</li>`).join('')}
                        ${senderData.anomaly_indicators.length > 3 ? `<li><small class="text-muted">+${senderData.anomaly_indicators.length - 3} more anomalies</small></li>` : ''}
                    </ul>
                    ` : '<p class="text-muted">No anomalies detected</p>'}
                    
                    ${senderData.behavior_flags && senderData.behavior_flags.length > 0 ? `
                    <p><strong>Behavioral Flags:</strong></p>
                    <div class="d-flex flex-wrap gap-1">
                        ${senderData.behavior_flags.slice(0, 4).map(flag => `<span class="badge bg-secondary" style="font-size: 0.7em;">${flag}</span>`).join('')}
                        ${senderData.behavior_flags.length > 4 ? `<span class="text-muted">+${senderData.behavior_flags.length - 4} more</span>` : ''}
                    </div>
                    ` : ''}
                </div>
            </div>
            ${senderData.domains_contacted && senderData.domains_contacted.length > 0 ? `
            <hr>
            <h6><i class="fas fa-globe text-primary"></i> External Domains Contacted</h6>
            <div class="d-flex flex-wrap gap-1">
                ${senderData.domains_contacted.slice(0, 15).map(domain => `<span class="badge bg-outline-secondary">${domain}</span>`).join('')}
                ${senderData.domains_contacted.length > 15 ? `<span class="text-muted">+${senderData.domains_contacted.length - 15} more domains</span>` : ''}
            </div>
            ` : ''}
            ${senderData.attachment_types && Object.keys(senderData.attachment_types).length > 0 ? `
            <hr>
            <h6><i class="fas fa-paperclip text-info"></i> Attachment Types</h6>
            <div class="row">
                ${Object.entries(senderData.attachment_types).map(([type, count]) => `
                <div class="col-3 text-center mb-2">
                    <span class="badge bg-info">${type}</span><br>
                    <small class="text-muted">${count} files</small>
                </div>
                `).join('')}
            </div>
            ` : ''}
        `;
        
        // Load additional data from API
        loadSenderDetailsFromAPI(senderEmail, modalBody);
    } else {
        modalBody.innerHTML = `
            <div class="alert alert-warning">
                <h6><i class="fas fa-exclamation-triangle"></i> Sender Not Found</h6>
                <p class="mb-0">Unable to find detailed analysis for sender: ${senderEmail}</p>
            </div>
        `;
    }
}

function findSenderData(senderEmail) {
    // Get the sender data from the current page's analysis data
    try {
        const analysisData = {{ analysis | tojson }};
        if (analysisData && analysisData.sender_profiles) {
            return analysisData.sender_profiles[senderEmail];
        }
    } catch (e) {
        console.error('Error accessing sender data:', e);
    }
    return null;
}

function loadSenderDetailsFromAPI(senderEmail, modalBody) {
    // Also fetch the latest data from API for more complete information
    fetch(`/api/sender_details/${window.currentSessionId}/${encodeURIComponent(senderEmail)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.warn('Could not load additional sender details:', data.error);
                return;
            }
            
            // Update the modal with additional recent activity information
            const recentActivityHtml = data.recent_activity && data.recent_activity.length > 0 
                ? `
                <hr>
                <h6>Recent Communications</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Recipient Domain</th>
                                <th>Subject</th>
                                <th>Risk Level</th>
                                <th>Attachments</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.recent_activity.map(activity => `
                                <tr>
                                    <td><span class="badge bg-outline-info">${activity.recipient_domain || 'N/A'}</span></td>
                                    <td><small>${activity.subject || 'No Subject'}</small></td>
                                    <td><span class="badge bg-${activity.risk_level === 'Critical' ? 'danger' : activity.risk_level === 'High' ? 'warning' : activity.risk_level === 'Medium' ? 'info' : 'success'}">${activity.risk_level || 'Low'}</span></td>
                                    <td>${activity.has_attachments ? '<i class="fas fa-paperclip text-info"></i>' : '<i class="fas fa-times text-muted"></i>'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : '';
                
            // Append the recent activity to the existing modal content
            modalBody.innerHTML += recentActivityHtml;
        })
        .catch(error => {
            console.error('Error loading additional sender details:', error);
        });
}

function analyzeSenderCommunications(senderEmail) {
    showLoading('Analyzing sender communications...');
    
    setTimeout(() => {
        hideLoading();
        showSuccess(`Communication analysis completed for ${senderEmail}`);
    }, 2000);
}

function flagSender(senderEmail) {
    if (confirm(`Flag ${senderEmail} for additional security review?`)) {
        showLoading('Flagging sender...');
        
        setTimeout(() => {
            hideLoading();
            showSuccess(`Sender ${senderEmail} has been flagged for review`);
        }, 1000);
    }
}

function exportSenderAnalysis() {
    showLoading('Preparing sender analysis export...');
    
    setTimeout(() => {
        hideLoading();
        showSuccess('Sender analysis exported successfully');
    }, 2000);
}

function exportSenderReport() {
    showLoading('Generating sender report...');
    
    setTimeout(() => {
        hideLoading();
        showSuccess('Sender report generated successfully');
        const modal = bootstrap.Modal.getInstance(document.getElementById('senderDetailsModal'));
        modal.hide();
    }, 1500);
}

function viewAnomalies(senderEmail) {
    const senderData = findSenderData(senderEmail);
    
    if (senderData && senderData.anomaly_indicators && senderData.anomaly_indicators.length > 0) {
        const anomalyHtml = `
            <div class="alert alert-warning">
                <h6><i class="fas fa-exclamation-triangle"></i> Behavioral Anomalies for ${senderEmail}</h6>
                <ul class="mb-0">
                    ${senderData.anomaly_indicators.map(anomaly => `<li>${anomaly}</li>`).join('')}
                </ul>
            </div>
            <p><strong>Recommendation:</strong> Review this sender's communications for potential security risks or policy violations.</p>
        `;
        
        const modal = document.getElementById('senderDetailsModal');
        const modalBody = document.getElementById('senderDetailsBody');
        modalBody.innerHTML = anomalyHtml;
        
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();
    } else {
        showWarning('No anomalies detected for this sender');
    }
}
</script>
{% endblock %}
